###RNAseq read mapping to annotated genome

My general workflow looked something like this:

1) Prepare annotation for STAR. This was a pain, because STAR generally wants a GTF, rather than a GFF like we get from Maker. I am sure that I tried to convert this to a GTF without success, but these days there are lots of tools to do this and maybe it could be done for the RBFW annotation. However, my workflow here worked fine so can just do this. First run `custom_make_star_gff.py` after editing these lines:

```
fp = open("wsfw_maker_renamed_nosemi_blast_ipr.gff")
outfile = open("STAR_wsfw_maker_renamed_nosemi_blast_ipr.gff","w")
```

To have RBFW files paths and names.
Then run like this:
```
python custom_make_star_gff.py
```

2) Edit `01_star_index.sh` to prepare an indexed refence to run with star.  I'm pretty sure that the below command can be removed:
```
--sjdbFileChrStartEnd $SJTAB
```

STAR should be able to extract splice junctions from the maker generated GFF, but if you want to run with more Sj evidence you could try to format the file found here:
```
/lustre/project/jk/Khalil_WD/RBFW_RNAseq/Genome_annotation/tophat_sj
```

That has a gff with splice junctions generated by tophat.

You should also check to see if STAR has been updated on cypress, but this could break it too.

3) Edit `02_star_map_annot.sh`

I use variable names to define paths, so change these to where your files are. SAMPLEDIR should be `/lustre/project/jk/Khalil_WD/RBFW_RNAseq/Preprocessing/Final_processed_fastq`
```
SAMPLEDIR=/home/eenbody/RNAseq_WD/QC_RNAseq/rRNA_removal/silva_full_ref
WORK_D=/home/eenbody/RNAseq_WD/Star/Star_annot_gene_names
STARREF=/lustre/project/jk/Enbody_WD/WSFW_DDIG/Reference_Genome_WSFW/STAR_sj_annot_gene_names
```

This little chunk sets up the job submission script to run as an array. This means it will run one job for each sample. You will have to edit this so that for it matches your names, but actually this should work I think. You can check this by (just on cypress command line) setting `SLURM_ARRAY_TASK_ID=1`, then see if `echo $FILENAME` produces what you expect.

```
cd $SAMPLEDIR
FILENAME=`ls -1 *clp.fq.1* | awk -v line=$SLURM_ARRAY_TASK_ID '{if (NR == line) print $0}'`
READ=$(echo $FILENAME | rev | cut -c 13- | rev)
cd $WORK_D
```

I think the rest of it should be good to go as is. But you should familiarize yourself with the STAR manual to see what each command does.

This script should be submitted as an array, one for each sample. So if you have 100 samples you would run it like the below command. You should try running it once with `--array=1` first to make sure it doesnt fail, then submit the rest.
```
sbatch --array=1-100 02_star_map_annot.sh
```

###Output

The output should include a bunch of files `*ReadsPerGene.out.tab.DEseq.input` that look like the below output. These are counts per gene (not transcript). This can be used as input for DeSeq2 using the import function that is used for RSEM (output is RSEM formatted output).
```
WSFW012017	0
WSFW012016	0
WSFW012018	11
WSFW012019	1
WSFW012020	172
WSFW007428	361
WSFW007429	11
WSFW007430	0
WSFW007431	728
WSFW007432	64
```
